---
import Button from './Button.astro';
import Icon from './Icon.astro';

interface Props {
  title: string;
  description: string;
  class?: string;
}

const { title, description, class: className = '' } = Astro.props;

// Generate id from title: lowercase, replace spaces with hyphens, remove special characters
const articleId = title
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '-')
  .replace(/^-+|-+$/g, '');
---

<article id={articleId} class={`grid gap-400 scroll-m-1000 ${className}`}>
  <div class="flex items-start gap-200 justify-between">
    <h3 class="text-title-h3">{title}</h3>
    <Button
      data-copy-link
      data-article-id={articleId}
      variant="light"
      class="shrink-0 p-200"
      title={`Copy link to ${title}`}
      aria-label={`Copy link to ${title}`}
    >
      <Icon name="mi/baseline/link" class="text-tone-neutral-04" />
    </Button>
  </div>
  <p class="text-info-detail">{description}</p>
  <slot />
</article>

<script define:vars={{ articleId }}>
  function initCopyLink() {
    const copyButtons = document.querySelectorAll('[data-copy-link]');

    copyButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const articleId = button.getAttribute('data-article-id');
        if (!articleId) return;

        // Get current URL with hash
        const url = new URL(window.location.href);
        url.hash = articleId;
        const urlWithHash = url.toString();

        try {
          // Copy to clipboard
          await navigator.clipboard.writeText(urlWithHash);

          // Update URL hash and scroll to anchor
          window.location.hash = articleId;
          const targetElement = document.getElementById(articleId);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }

          // Visual feedback: temporarily change icon
          const icon = button.querySelector('.iconsauce-icon');
          if (icon) {
            icon.className = icon.className.replace(/mi\/baseline\/link/, 'mi/baseline/check');
            button.setAttribute('aria-label', 'Link copied!');
            button.setAttribute('title', 'Link copied!');

            setTimeout(() => {
              icon.className = icon.className.replace(/mi\/baseline\/check/, 'mi/baseline/link');
              const article = button.closest('article');
              const titleText = article?.querySelector('h3')?.textContent || '';
              button.setAttribute('aria-label', `Copy link to ${titleText}`);
              button.setAttribute('title', `Copy link to ${titleText}`);
            }, 2000);
          }
        } catch (err) {
          console.error('Failed to copy link:', err);
        }
      });
    });
  }

  function scrollToHash() {
    // Check if there's a hash in the URL
    if (window.location.hash) {
      const hash = window.location.hash.substring(1); // Remove the # symbol
      const targetElement = document.getElementById(hash);
      if (targetElement) {
        // Small delay to ensure page is fully rendered
        setTimeout(() => {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    }
  }

  function initUseCaseCLS() {
    // Get the scope for this use case using the article ID
    const scope = window.getUseCaseScope?.(articleId);
    if (!scope || !scope.container) return;

    // Initialize CLS prevention and viewport opacity for this use case
    if (window.removeCLSPreventStyle) {
      setTimeout(() => {
        window.removeCLSPreventStyle(scope.container);
      }, 100);
      // Also try after a longer delay as fallback
      setTimeout(() => {
        window.removeCLSPreventStyle(scope.container);
      }, 1000);
    }

    if (window.initViewportOpacity) {
      window.initViewportOpacity(scope.container);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initCopyLink();
      scrollToHash();
      initUseCaseCLS();
    });
  } else {
    initCopyLink();
    scrollToHash();
    initUseCaseCLS();
  }
</script>
