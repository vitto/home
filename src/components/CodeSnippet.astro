---
import { codeToHtml } from 'shiki';

/**
 * CodeSnippet Component
 *
 * Displays formatted code snippets with syntax highlighting using Shiki
 *
 * Props:
 * @param {string} language - Language of the code ('html' | 'javascript' | 'js' | any Shiki supported language)
 * @param {string} code - The code content to display
 * @param {string} title - Optional title for the code block
 */
interface Props {
  language?: string;
  code: string;
  variant?: 'none' | 'do' | 'dont' | 'warn';
  title?: string;
  class?: string;
}

const {
  language = 'html',
  code: rawCode,
  title,
  class: className = '',
  variant = 'none',
} = Astro.props;

// Trim initial and final newlines and whitespace
const code = rawCode.trim();

// Normalize language names (js -> javascript)
const normalizedLanguage = language === 'js' ? 'javascript' : language;

const languageBadgeVariant: Record<string, string> = {
  javascript: 'amaranth',
  html: 'violet',
  css: 'blue',
  json: 'yellow',
  text: 'blue',
};

// Highlight the code using Shiki
const highlightedCode = await codeToHtml(code, {
  lang: normalizedLanguage,
  theme: 'github-dark',
});

const uniqueId = `code-${Math.random().toString(36).substring(2, 9)}`;
const codeClass =
  `code-snippet-code language-${normalizedLanguage} ${language === 'text' ? 'text-tone-neutral' : ''}`.trim();
// Inject full Shiki output into one container (avoids set:html on <code> which can break
// DOM parsing on iOS/Android when inner content contains entity-encoded tags like </code>)
const highlightedCodeWithId = highlightedCode.replace(
  /<code[^>]*/,
  `<code id="${uniqueId}" data-language="${normalizedLanguage}" class="${codeClass}"`
);
---

<div
  class={`code-snippet-container grid gap-400 grid-cols-full select-none mobile:rounded-none ${className}`}
>
  <div class="flex items-center justify-center gap-200">
    {
      variant === 'do' && (
        <mds-badge variant="success" tone="strong">
          allowed
        </mds-badge>
      )
    }
    {
      variant === 'dont' && (
        <mds-badge variant="error" tone="strong">
          not allowed
        </mds-badge>
      )
    }
    {
      variant === 'warn' && (
        <mds-badge variant="warning" tone="strong">
          warning
        </mds-badge>
      )
    }
    {
      title && (
        <p class="justify-self-center text-info-option text-tone-neutral-09 dark:text-tone-neutral-01">
          {title}
        </p>
      )
    }
  </div>
  <div class="relative grid min-w-0 w-full">
    <mds-badge
      variant={languageBadgeVariant[normalizedLanguage]}
      tone="weak"
      class="absolute top-400 right-400">{normalizedLanguage}</mds-badge
    >
    <div class="code-snippet-pre-wrap" set:html={highlightedCodeWithId} />
  </div>
</div>
