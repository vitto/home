---
import Button from './Button.astro';
import Icon from './Icon.astro';
import categoriesData from '../data/categories.json';
import personalData from '../data/personal.json';

interface Props {
  items?: Array<{
    href: string;
    label: string;
    icon: string;
    button: string;
    current: number;
    buttonSelected?: string;
  }>;
}

const baseUrl = import.meta.env.BASE_URL;

// Determine current section from URL pathname
const currentPath = Astro.url.pathname;
const currentSection = categoriesData.find((category) => currentPath.includes(category.path));

// Map categories data to header items format
const defaultItems = categoriesData.map((category) => {
  const isCurrentSection = currentSection?.id === category.id;
  return {
    href: `${baseUrl}${category.path}`,
    icon: category.icon,
    label: category.title,
    current: isCurrentSection ? -1 : 0,
    button: isCurrentSection ? category.buttonSelected : category.button,
  };
});

const { items = defaultItems } = Astro.props;
---

<div>
  <header class="flex items-center gap-400 justify-between">
    <div class="inline-flex items-center gap-400 pb-200">
      <a
        title="Back to Home"
        href={baseUrl}
        class="inline-flex focus-bounce rounded-full shrink-0 hover:rotate-[60deg] focus-visible:rotate-[60deg] ease-out-expo transition-transform duration-500"
      >
        <img
          alt="Vittorio Vittori Logo"
          src={`${baseUrl}/vittorio-vittori-logo.svg`}
          class="w-1600 h-1600 mobile:w-1600 mobile:h-1600 justify-self-center"
        />
      </a>
      <div class="grid mobile:hidden">
        <h2 class="text-title-h3">
          Vittori<span class="inline-block animate-pulse-more">o</span>
        </h2>
        <p class="text-info-caption">{personalData.role}</p>
      </div>
    </div>
    <button
      type="button"
      class="inline-flex focus-bounce rounded-2xl shrink-0 no-underline bg-transparent border-none cursor-pointer"
      data-menu-toggle
      aria-label="Toggle menu"
    >
      <Icon class="mobile:text-[32px]" name="mi/round/menu" />
    </button>
    <div
      class="header-nav grid grid-cols-[1fr_auto] tablet:grid-cols-[1fr_768px_1fr]"
      data-header-nav
    >
      <nav
        class="header-nav-menu col-start-2 flex flex-col items-start gap-400 bg-tone-neutral rounded-2xl py-600"
        data-header-nav-menu
      >
        <div class="mobile:grid hidden">
          <h2 class="text-title-h3">
            Vittori<span class="inline-block animate-pulse-more">o</span>
          </h2>
          <p class="text-info-tip">{personalData.role}</p>
        </div>
        {
          items.map((item) => (
            <Button href={item.href} class={item.button} tabIndex={item.current}>
              <Icon name={item.icon} />
              {item.label}
            </Button>
          ))
        }
      </nav>
    </div>
  </header>
  <div class="h-50 bg-tone-neutral-03"></div>
</div>
<script>
  function initHeaderMenu() {
    const menuToggle = document.querySelector('[data-menu-toggle]');
    const headerNav = document.querySelector('[data-header-nav]');
    const headerNavMenu = document.querySelector('[data-header-nav-menu]');

    if (!menuToggle || !headerNav || !headerNavMenu) return;

    const openMenu = () => {
      headerNav.classList.add('header-nav--opened');
      headerNavMenu.classList.add('header-nav-menu--opened');
    };

    const closeMenu = () => {
      headerNav.classList.remove('header-nav--opened');
      headerNavMenu.classList.remove('header-nav-menu--opened');
    };

    const toggleMenu = () => {
      const isOpen = headerNav.classList.contains('header-nav--opened');
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    };

    // Toggle menu on button click
    menuToggle.addEventListener('click', (e) => {
      e.preventDefault();
      toggleMenu();
    });

    // Close menu when clicking on header-nav (but not on the menu itself)
    headerNav.addEventListener('click', (e) => {
      // Only close if clicking directly on header-nav, not on children
      if (e.target === headerNav) {
        closeMenu();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeaderMenu);
  } else {
    initHeaderMenu();
  }
</script>
