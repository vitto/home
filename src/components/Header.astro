---
import Button from './Button.astro';
import Icon from './Icon.astro';
import HeaderMenu from './HeaderMenu.astro';
import personalData from '../data/personal.json';

interface Props {
  items?: Array<{
    href: string;
    label: string;
    icon: string;
    button: string;
    current: number;
    headerSelected?: string;
  }>;
  menu?: boolean;
}

// Get base URL from Astro config and normalize it
// Remove trailing slash if present (except for root)
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl === '/' ? '' : rawBaseUrl.replace(/\/$/, '');
const { menu = true } = Astro.props;
---

<header class="flex items-center gap-400 justify-between group/header">
  <div class="inline-flex items-center gap-400">
    <a
      title="Back to Home"
      href={baseUrl || '/'}
      class="inline-flex focus-bounce rounded-full shrink-0 hover:rotate-[60deg] hover:translate-y-[8px] focus-visible:rotate-[60deg] focus-visible:translate-y-[8px] ease-out-expo transition-transform duration-500 no-underline"
    >
      <Icon name="vv/logo" class="text-[48px] justify-self-center" />
    </a>
    <div class="hidden desktop:grid">
      <h1 class="text-title-h3" aria-label="Vittorio Vittori">
        Vittori<mds-text
          aria-hidden="true"
          class="inline-block animate-pulse-more group-hover/header:opacity-100"
          tag="span"
          typography="h3"
          animation="jugop"
          text="o"
          data-name></mds-text>
      </h1>
      <mds-text
        tag="span"
        class="header-role min-h-200"
        typography="option"
        data-claim={personalData.claim}
        data-roles={personalData.role}
        text={personalData.role.split('/')[0]}
        animation="jugop"></mds-text>
    </div>
  </div>
  {
    menu ? (
      <HeaderMenu />
    ) : (
      <Button href={baseUrl || '/'} variant="light" class="shrink-0 py-300" title="Back to Home">
        <Icon name="mi/outline/home" class="text-tone-neutral-04" />
      </Button>
    )
  }
</header>

<script>
  function initHeaderHover() {
    const header = document.querySelector('header');
    const mdsText = document.querySelector('mds-text[data-name]');
    const mdsTextRole = document.querySelector('[data-roles]');
    const duration = 5000;

    if (!header || !mdsText || !mdsTextRole) return;

    const textRoles = mdsTextRole.getAttribute('data-roles')?.split('/') || [];
    const textClaim = mdsTextRole.getAttribute('data-claim');

    if (textRoles.length === 0) return;

    let currentRoleIndex = 1;
    let roleInterval: number | null = null;
    let isHovering = false;

    function updateRoleText() {
      if (!isHovering && textRoles.length > 0 && mdsTextRole) {
        mdsTextRole.setAttribute('text', textRoles[currentRoleIndex] || '');
        currentRoleIndex = (currentRoleIndex + 1) % textRoles.length;
      }
    }

    function startRoleRotation() {
      if (roleInterval) return; // Already running
      roleInterval = window.setInterval(updateRoleText, duration);
    }

    function stopRoleRotation() {
      if (roleInterval) {
        clearInterval(roleInterval);
        roleInterval = null;
      }
    }

    header.addEventListener('mouseenter', () => {
      isHovering = true;
      stopRoleRotation();
      mdsText.setAttribute('text', 'o Vittori');
      mdsTextRole.setAttribute('text', textClaim || '');
    });

    header.addEventListener('mouseleave', () => {
      isHovering = false;
      mdsText.setAttribute('text', 'o');
      // Reset to first role and start rotation
      // currentRoleIndex = 0;
      updateRoleText();
      startRoleRotation();
    });

    // Start rotation on page load
    startRoleRotation();
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeaderHover);
  } else {
    initHeaderHover();
  }
</script>
