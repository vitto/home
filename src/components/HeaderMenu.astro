---
import Button from './Button.astro';
import Icon from './Icon.astro';
import Footer from './Footer.astro';
import categoriesData from '../data/categories.json';
import personalData from '../data/personal.json';
import HeaderButton from './HeaderButton.astro';

interface Props {
  size?: 'sm' | 'lg';
  iconColor?: string;
}

const { size = 'lg', iconColor = 'text-tone-neutral-03' } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;

// Determine current section from URL pathname
const currentPath = Astro.url.pathname;
const currentSection = categoriesData.find((category) => currentPath.includes(category.path));

// Map categories data with full link URLs for CategoryCardItem
const categories = categoriesData.map((category) => ({
  ...category,
  link: `${baseUrl}${category.path}`,
}));
---

<div class="flex flex-wrap gap-200">
  {
    size === 'lg' &&
      categories.map((category) => {
        const isSelected = currentSection?.id === category.id;
        return (
          <HeaderButton
            href={category.link}
            class="mobile:hidden"
            title={category.shortTitle}
            description={category.title}
            defaultClass={category.defaultClass}
            selectedClass={category.selectedClass}
            selected={isSelected}
          />
        );
      })
  }
  <Button
    data-menu-toggle
    title="Toggle menu"
    variant="light"
    class="inline-flex group focus-bounce rounded-2xl shrink-0 no-underline bg-transparent border-none cursor-pointer size-1200"
  >
    <Icon class={`mobile:text-[32px] transition-colors ${iconColor}`} name="mi/outline/menu" />
  </Button>
</div>
<div class="header-nav text-tone-neutral-02 hidden" data-header-nav hidden>
  <nav class="header-nav-menu grid-cols-fill auto-rows-min" data-header-nav-menu>
    <div class="flex items-center justify-between">
      <div class="grid text-tone-neutral-03">
        <h2 class="text-title-h3">
          Vittori<span class="inline-block animate-pulse-more">o</span>
        </h2>
        <p class="text-info-tip">{personalData.role}</p>
      </div>
      <Button href={baseUrl} variant="light" class="shrink-0 py-300" title="Back to Home">
        <Icon name="mi/outline/home" class="text-tone-neutral-04" />
      </Button>
    </div>
    <div class="h-50 bg-tone-neutral-03 w-full flex tablet:hidden"></div>
    <div class="grid gap-400 grid-cols-fit-lg mobile:grid-cols-full tablet:hidden" data-nav-buttons>
      {
        categories.map((category) => {
          const isSelected = currentSection?.id === category.id;
          return (
            <HeaderButton
              icon={category.icon}
              href={category.link}
              title={category.shortTitle}
              description={category.title}
              defaultClass={category.defaultClass}
              selectedClass={category.selectedClass}
              selected={isSelected}
            />
          );
        })
      }
    </div>
    <div class="h-50 bg-tone-neutral-03 w-full"></div>
    <div class="inline-flex">
      <mds-pref class="max-w-8000 w-full text-tone-neutral-03">
        <mds-pref-theme></mds-pref-theme>
        {/* <mds-pref-contrast /> */}
        {/* <mds-pref-animation /> */}
      </mds-pref>
    </div>
    <div class="h-50 bg-tone-neutral-03 w-full"></div>
    <Footer class="py-600" />
  </nav>
</div>

<script>
  function initHeaderMenu() {
    const menuToggles = document.querySelectorAll('[data-menu-toggle]');
    const headerNav = document.querySelector('[data-header-nav]');
    const headerNavMenu = document.querySelector('[data-header-nav-menu]');

    if (!menuToggles || !headerNav || !headerNavMenu) return;

    // Toggle menu on button click
    menuToggles.forEach((menuToggle) => {
      menuToggle.addEventListener('click', (e) => {
        e.preventDefault();
        toggleMenu();
      });
    });

    headerNav.removeAttribute('hidden');

    const openMenu = () => {
      headerNav.classList.remove('hidden');
      setTimeout(() => {
        headerNav.classList.add('header-nav--opened');
        headerNavMenu.classList.add('header-nav-menu--opened');
      }, 10);
    };

    const closeMenu = () => {
      headerNav.classList.remove('header-nav--opened');
      headerNavMenu.classList.remove('header-nav-menu--opened');
      setTimeout(() => {
        headerNav.classList.add('hidden');
      }, 501);
    };

    const toggleMenu = () => {
      const isOpen = headerNav.classList.contains('header-nav--opened');
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    };

    // Close menu when clicking on header-nav (but not on the menu itself)
    headerNav.addEventListener('click', (e) => {
      // Only close if clicking directly on header-nav, not on children
      if (e.target === headerNav) {
        closeMenu();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeaderMenu);
  } else {
    initHeaderMenu();
  }
</script>
