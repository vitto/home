---
import Button from './Button.astro';

/**
 * CategoryFilter Component
 *
 * Client-side filter buttons for filtering principles by category
 * Remembers filter selection per section using localStorage
 *
 * Props:
 * @param {string[]} categories - Array of category names
 * @param {string} activeCategory - Currently active category (empty string = all)
 * @param {string} sectionId - Section identifier for localStorage (defaults to URL pathname)
 * @param {string} class - Additional CSS classes
 */
interface Props {
  categories: string[];
  activeCategory?: string;
  sectionId?: string;
  class?: string;
}

const { categories, activeCategory = '', sectionId, class: className = '' } = Astro.props;
---

<div class={`flex flex-wrap gap-200 scroll-mt-600 ${className}`} data-filter-container>
  <Button data-filter="all" data-filter-active="false" variant="outline">All</Button>
  {
    categories.map((category) => (
      <Button data-filter={category} data-filter-active="false">
        <span class="first-letter:uppercase">{category}</span>
      </Button>
    ))
  }
</div>

<script define:vars={{ sectionId: sectionId || '' }}>
  function initCategoryFilter() {
    const filterContainer = document.querySelector('[data-filter-container]');
    if (!filterContainer) return;

    const filterButtons = filterContainer.querySelectorAll('[data-filter]');
    const principleCards = document.querySelectorAll('[data-principle-id]');

    // Determine section ID from prop or URL pathname
    const getSectionId = () => {
      if (sectionId && sectionId.trim() !== '') return sectionId;

      // Extract section from URL pathname
      // Examples:
      // /home/user-centered-design -> user-centered-design
      // /home/design-systems -> design-systems
      // /home/human-centered-ai-design -> human-centered-ai-design
      const pathname = window.location.pathname;
      // Remove trailing slash and get last segment
      const segments = pathname.replace(/\/$/, '').split('/').filter(Boolean);
      const lastSegment = segments[segments.length - 1];

      // Known section names
      const knownSections = ['user-centered-design', 'design-systems', 'human-centered-ai-design'];
      if (knownSections.includes(lastSegment)) {
        return lastSegment;
      }

      return 'default';
    };

    const currentSectionId = getSectionId();
    const storageKey = `filter-${currentSectionId}`;

    // Load saved filter from localStorage
    const loadSavedFilter = () => {
      try {
        const savedFilter = localStorage.getItem(storageKey);
        if (savedFilter) {
          return savedFilter;
        }
      } catch (e) {
        console.warn('Failed to load filter from localStorage:', e);
      }
      return null;
    };

    // Save filter to localStorage
    const saveFilter = (filterValue) => {
      try {
        localStorage.setItem(storageKey, filterValue);
      } catch (e) {
        console.warn('Failed to save filter to localStorage:', e);
      }
    };

    // Apply filter (update UI and filter cards)
    const applyFilter = (filterValue) => {
      console.log('applyFilter', filterValue);
      // Update active state - CSS handles styling via data-filter-active attribute
      filterButtons.forEach((btn) => {
        const isActive = btn.getAttribute('data-filter') === filterValue;
        btn.setAttribute('data-filter-active', String(isActive));
      });

      // Filter cards
      principleCards.forEach((card) => {
        const cardCategory = card.getAttribute('data-category');
        const innerCard = card.querySelector('.principle-card');
        const shouldShow = cardCategory === filterValue;

        innerCard.classList.remove('duration-500');
        innerCard.classList.add('duration-0');

        if (shouldShow) {
          card.classList.add('order-first');
          innerCard.setAttribute('data-filtered', 'true');
        } else {
          card.classList.remove('order-first');
          innerCard.removeAttribute('data-filtered');
        }
      });

      setTimeout(() => {
        principleCards.forEach((card) => {
          const innerCard = card.querySelector('.principle-card');
          innerCard.classList.remove('duration-0');
          innerCard.classList.add('duration-500');
        });
      }, 10);
    };

    // Check for category query parameter first (takes precedence over saved filter)
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('category');

    // Initialize with query parameter, saved filter, or no selection
    let filterToApply = null;
    if (categoryParam) {
      // Use query parameter if present
      filterToApply = categoryParam;
      // Save it to localStorage for future visits
      saveFilter(filterToApply);
    } else {
      // Otherwise use saved filter
      filterToApply = loadSavedFilter();
    }

    if (filterToApply) {
      // Small delay to allow initial render, then apply filter for transition effect
      requestAnimationFrame(() => {
        applyFilter(filterToApply);
      });
    }

    // Add click listeners
    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const filterValue = button.getAttribute('data-filter');
        saveFilter(filterValue);
        applyFilter(filterValue);

        // Scroll to top of filter container
        filterContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCategoryFilter);
  } else {
    initCategoryFilter();
  }
</script>
