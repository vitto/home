---
import UseCase from '../../../UseCase.astro';
import UseCaseInteractive from '../../../UseCaseInteractive.astro';
import usersData from '../../../../data/visibility-of-system-status/users.json';
import { getStatusClass } from '../../../../data/visibility-of-system-status/helpers';
import Usage from '../../../Usage.astro';
import UsageItem from '../../../UsageItem.astro';

const baseUrl = import.meta.env.BASE_URL;

// Map users with full avatar URLs
const users = usersData.map((user) => ({
  ...user,
  avatar: `${baseUrl}${user.avatar}`,
}));
---

<UseCase
  title="Errors and Problems"
  description="The system promptly reports anomalies and crashes, explaining what is happening and whether any action is required."
>
  <UseCaseInteractive clsHeight={360}>
    <mds-button class="transition" variant="dark" data-simulate-button>
      Simulate connection problem
    </mds-button>
    <div
      class="inline-flex flex-col items-center gap-400 p-600 rounded-xl bg-tone-neutral-09 relative w-full max-w-8000"
    >
      <mds-push-notification-item
        deletable="false"
        icon="mi/baseline/wifi-tethering-error"
        message="Please check your internet connection and try again."
        subject="Connection lost"
        variant="error"
        class="transition absolute top-100 right-100 left-100 opacity-0 -translate-y-600 pointer-events-none z-10"
        data-error-notification
      >
        <mds-button size="sm" slot="action" tone="weak" variant="error" data-retry-button
          >Retry</mds-button
        >
      </mds-push-notification-item>
      {
        users.map((user) => (
          <mds-author class="gap-200 min-h-600">
            <div
              slot="avatar"
              class="inline-flex items-center justify-center relative"
              title={`${user.name} is ${user.status}`}
              data-user-title
            >
              <mds-avatar src={user.avatar} class="size-600" />
              <div
                class={`size-300 rounded-full ${getStatusClass(user.status as 'online' | 'offline' | 'busy' | 'error')} absolute bottom-0 -right-100 border-solid border-2 border-tone-neutral-09 transition`}
                data-status-indicator
              />
            </div>
            <mds-text typography="detail">{user.name}</mds-text>
          </mds-author>
        ))
      }
      <mds-entity
        src={`${baseUrl}/assets/example-avatar-05.png`}
        class="w-full max-w-8000 min-h-[60px]"
      >
        <mds-text typography="h6">Mario Rossi</mds-text>
        <div
          slot="detail"
          class="size-300 rounded-full bg-status-success-06 transition"
          data-status-indicator
        >
        </div>
        <mds-text typography="caption" slot="detail" data-status-text>Offline</mds-text>
        <div slot="action" class="inline-flex items-center justify-center fill-tone-neutral-04">
          <mds-icon name="mi/outline/more-vert"></mds-icon>
        </div>
      </mds-entity>
    </div>
    <script>
      function initConnectionDemo() {
        // Get the UseCase scope (article and container) for this script
        const scope = (window as any).getUseCaseScope?.('errors-and-problems');
        if (!scope) return;

        const { container } = scope;

        const simulateButton = container.querySelector('[data-simulate-button]');
        const notification = container.querySelector('[data-error-notification]');
        const retryButton = container.querySelector('[data-retry-button]');
        const statusIndicator = container.querySelector('[data-status-indicator]');
        const statusText = container.querySelector('[data-status-text]');

        // Find all user status indicators (both in mds-author and mds-entity)
        const allStatusIndicators = Array.from(
          container.querySelectorAll('[data-status-indicator]')
        ) as HTMLElement[];

        // Find all user title elements
        const allUserTitles = Array.from(
          container.querySelectorAll('[data-user-title]')
        ) as HTMLElement[];

        if (!simulateButton || !notification || !retryButton || !statusIndicator || !statusText)
          return;

        // Store original status classes for all indicators
        const originalStatusClasses = allStatusIndicators.map((indicator) => {
          // Get the current status class (online, offline, busy, error)
          const classes = indicator.className.split(' ');
          const statusClass =
            classes.find(
              (cls) =>
                cls.startsWith('bg-status-') ||
                cls.startsWith('bg-label-') ||
                cls.startsWith('bg-tone-')
            ) || 'bg-status-success-06';
          return statusClass;
        });

        // Store original titles for all user title elements
        const originalTitles = allUserTitles.map((titleElement) => {
          return titleElement.getAttribute('title') || '';
        });

        const restoreInitialState = () => {
          // Show simulate button
          simulateButton.classList.remove('translate-x-600');
          simulateButton.classList.remove('opacity-0');
          simulateButton.classList.remove('pointer-events-none');
          simulateButton.classList.add('opacity-100');
          // Hide notification (connection is functional)
          notification.classList.remove('opacity-100');
          notification.classList.remove('translate-y-0');
          notification.classList.remove('delay-500');
          notification.classList.add('opacity-0');
          notification.classList.add('pointer-events-none');
          notification.classList.add('-translate-y-600');
          // Restore all status indicators to their original state
          allStatusIndicators.forEach((indicator, index) => {
            // Restore original status class
            indicator.classList.remove(
              'bg-status-success-06',
              'bg-status-error-06',
              'bg-label-orange-07',
              'bg-tone-neutral-07',
              'bg-tone-neutral-06'
            );
            indicator.classList.add(originalStatusClasses[index]);
          });
          // Restore original titles
          allUserTitles.forEach((titleElement, index) => {
            titleElement.setAttribute('title', originalTitles[index]);
          });
          // Change status text to Online
          statusText.textContent = 'Online';
        };

        const simulateConnectionProblem = () => {
          // Hide simulate button
          simulateButton.classList.add('translate-x-600');
          simulateButton.classList.add('opacity-0');
          simulateButton.classList.add('pointer-events-none');
          simulateButton.classList.remove('opacity-100');
          // Show notification (connection problem)
          notification.classList.remove('opacity-0');
          notification.classList.remove('-translate-y-600');
          notification.classList.add('delay-500');
          notification.classList.remove('pointer-events-none');
          notification.classList.add('opacity-100');
          // Set all status indicators to error state
          allStatusIndicators.forEach((indicator) => {
            // Remove all status classes
            indicator.classList.remove(
              'bg-status-success-06',
              'bg-status-error-06',
              'bg-label-orange-07',
              'bg-tone-neutral-06',
              'bg-tone-neutral-07'
            );
            // Add error class
            indicator.classList.add('bg-tone-neutral-07');
          });
          // Change all user titles to "Connection error"
          allUserTitles.forEach((titleElement) => {
            titleElement.setAttribute('title', 'Connection error');
          });
          // Change status text to Offline
          statusText.textContent = 'Offline';
        };

        // Set initial state
        restoreInitialState();

        // Add event listeners
        simulateButton.addEventListener('click', simulateConnectionProblem);
        retryButton.addEventListener('click', restoreInitialState);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initConnectionDemo);
      } else {
        initConnectionDemo();
      }
    </script>
  </UseCaseInteractive>
  <Usage>
    <UsageItem variant="do">Explain errors in clear, user-oriented language</UsageItem>
    <UsageItem variant="dont">Display raw technical or system error codes</UsageItem>
    <UsageItem variant="do">Indicate whether user action is required and what to do next</UsageItem>
    <UsageItem variant="dont">Show errors without recovery options when possible</UsageItem>
    <UsageItem variant="do">Surface errors immediately when they occur</UsageItem>
    <UsageItem variant="dont">Silently fail or delay error communication</UsageItem>
  </Usage>
</UseCase>
