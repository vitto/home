---
import UseCase from '../../../UseCase.astro';
import UseCaseInteractive from '../../../UseCaseInteractive.astro';
import Usage from '../../../Usage.astro';
import UsageItem from '../../../UsageItem.astro';
import Markdown from '../../../Markdown.astro';
import AIBalloon from '../../AIBalloon.astro';
import AIBalloonMessage from '../../AIBalloonMessage.astro';
import AIResponseMessage from '../../AIResponseMessage.astro';
import Highlight from '../../Highlight.astro';
import AIContext from '../../AIContext.astro';
import AIInput from '../../AIInput.astro';
import AIInputWrapper from '../../AIInputWrapper.astro';

const languageTones = [
  { value: '0', label: 'Automatic', message: 'The tone is automatically detected' },
  {
    value: '1',
    label: 'Technical',
    message: 'The TCP/IP protocol ensures reliable data packet transmission.',
  },
  { value: '2', label: 'Friendly', message: 'Hi there! How can I brighten your day? ðŸ˜Š' },
  {
    value: '3',
    label: 'Formal',
    message: 'Please submit the required documentation by February 20, 2026.',
  },
  { value: '4', label: 'Casual', message: 'Hey, whatâ€™s up? Let me know if you need anything!' },
  {
    value: '5',
    label: 'Humorous',
    message: 'If Wi-Fi were a superhero, today it wouldâ€™ve lost its cape... ðŸ˜…',
  },
  {
    value: '6',
    label: 'Educational',
    message: 'Photosynthesis occurs in leaves using sunlight to produce energy.',
  },
  {
    value: '7',
    label: 'Informative',
    message: 'The event will take place on February 25 at 3:00 PM in the Green Hall.',
  },
  {
    value: '8',
    label: 'Persuasive',
    message: 'Discover how to save 30% on your billâ€”click here to learn more!',
  },
  {
    value: '9',
    label: 'Engaging',
    message: 'Imagine a world without plasticâ€”what would change for you? Share your thoughts!',
  },
  {
    value: '10',
    label: 'Inspiring',
    message: 'Every small step counts: today is the perfect day to start believing in yourself.',
  },
];
const defaultLanguageTone = '3';
const defaultLanguageToneMessage =
  languageTones.find((tone) => tone.value === defaultLanguageTone)?.message ?? '';
---

<UseCase
  title="Learning From the User Without Lock-In"
  description="Improve suggestions and behavior from user feedback and behavior, but let users see, correct, or reset personalization so they don't feel locked in."
>
  <UseCaseInteractive
    clsHeight={628}
    label="Learning without lock-in"
    articleId="learning-from-the-user-without-lock-in"
    toggle
  >
    <div class="grid gap-600 w-full max-w-9600">
      <AIBalloon>
        <AIBalloonMessage>Write an email to cancel an electricity supply contract</AIBalloonMessage>
      </AIBalloon>
      <AIResponseMessage>
        <Markdown
          typography="detail"
          content={`
Subject: Request to withdraw from the electricity supply contract (No. [XXX])

Dear [Supplier Name],
I hereby communicate my intention to withdraw from the electricity supply contract signed on [XX/XX/XXXX], pursuant to Article [Y] of the Consumer Code.
Termination of the contract is requested effective from [date].
Kind regards,

[Name and user data]
      `}
        />
      </AIResponseMessage>
      <AIInputWrapper>
        <AIInput />
        <Highlight label="Context management" class="relative grid gap-600">
          <AIContext value={76}>
            <mds-separator></mds-separator>
            <mds-input-switch data-use-personal-data class="flex-row-reverse justify-between"
              >Use personal data</mds-input-switch
            >
            <mds-separator></mds-separator>
            <mds-input-switch
              checked
              data-consider-previous-messages
              class="flex-row-reverse justify-between"
              >Consider previous messages <mds-badge class="ml-100" variant="dark" tone="ghost"
                >14</mds-badge
              ></mds-input-switch
            >
            <mds-separator></mds-separator>
            <mds-input-field label="tone" message={defaultLanguageToneMessage} data-tone-select>
              <mds-input-select data-select-list value={defaultLanguageTone}>
                {languageTones.map((tone) => <option value={tone.value}>{tone.label}</option>)}
              </mds-input-select>
            </mds-input-field>
            <div class="h-full flex flex-col items-stretch justify-end gap-600">
              <mds-text>This will affect only the current conversation</mds-text>
              <mds-button variant="error" tone="weak" data-purge-context>Purge context</mds-button>
            </div>
          </AIContext>
        </Highlight>
      </AIInputWrapper>
    </div>
    <div class="grid gap-600 w-full max-w-9600">
      <AIBalloon>
        <AIBalloonMessage>Write an email to cancel an electricity supply contract</AIBalloonMessage>
      </AIBalloon>
      <AIResponseMessage>
        <Markdown
          typography="detail"
          content={`
Subject: Request to withdraw from the electricity supply contract (No. [XXX])

Dear [Supplier Name],
I hereby communicate my intention to withdraw from the electricity supply contract signed on [XX/XX/XXXX], pursuant to Article [Y] of the Consumer Code.
Termination of the contract is requested effective from [date].
Kind regards,

[Name and user data]
      `}
        />
      </AIResponseMessage>
      <AIInputWrapper>
        <AIInput />
      </AIInputWrapper>
    </div>
  </UseCaseInteractive>
  <script define:vars={{ languageTones, defaultLanguageTone, defaultLanguageToneMessage }}>
    function setToneSelectValue(toneSelect, value) {
      console.log('setToneSelectValue', value);
      const selectEl = toneSelect?.querySelector('[data-select-list]');
      if (!selectEl) return;
      selectEl.setValue(value);
      // selectEl.value = value;
      console.log('selectEl', selectEl);
      const message = languageTones.find((tone) => tone.value === value)?.message ?? '';
      toneSelect.setAttribute('message', message);
    }

    function initLearningFromTheUserWithoutLockIn() {
      const toneSelect = document.querySelector('[data-tone-select]');
      if (toneSelect) {
        toneSelect.addEventListener('mdsInputSelectChange', (event) => {
          const message =
            languageTones.find((tone) => tone.value === event.detail?.value)?.message ?? '';
          toneSelect.setAttribute('message', message);
        });
      }

      const purgeButton = document.querySelector('[data-purge-context]');
      if (purgeButton) {
        const originalButtonText = purgeButton.textContent || 'Purge context';
        const originalContextBarValue = '76';
        const originalContextBarAlias = 'very high';

        purgeButton.addEventListener('click', () => {
          // Store current state for rollback
          const currentToneValue =
            toneSelect?.querySelector('[data-select-list]')?.value || defaultLanguageTone;
          const usePersonalDataChecked =
            document.querySelector('[data-use-personal-data]')?.hasAttribute('checked') || false;
          const considerPreviousMessagesChecked =
            document.querySelector('[data-consider-previous-messages]')?.hasAttribute('checked') ||
            true;

          // Set loading state
          purgeButton.setAttribute('await', '');
          purgeButton.textContent = 'Purging...';

          // Reset tone select to 0 (purge value)
          if (toneSelect) {
            setToneSelectValue(toneSelect, '0');
          }

          // Uncheck switches
          const usePersonalDataSwitch = document.querySelector('[data-use-personal-data]');
          if (usePersonalDataSwitch) {
            usePersonalDataSwitch.removeAttribute('checked');
            usePersonalDataSwitch.checked = false;
          }

          const considerPreviousMessagesSwitch = document.querySelector(
            '[data-consider-previous-messages]'
          );
          if (considerPreviousMessagesSwitch) {
            considerPreviousMessagesSwitch.removeAttribute('checked');
            considerPreviousMessagesSwitch.checked = false;
          }

          // Reset context bar to 0 (none)
          const contextBar = document.querySelector('[data-context-bar]');
          if (contextBar) {
            contextBar.setAttribute('value', '0');
            contextBar.setAttribute('alias', 'none');
          }

          const modal = document.querySelector('[data-modal]');

          const doRollback = () => {
            purgeButton.removeAttribute('await');
            purgeButton.textContent = originalButtonText;

            if (toneSelect) {
              setToneSelectValue(toneSelect, defaultLanguageTone);
            }

            if (usePersonalDataSwitch) {
              if (usePersonalDataChecked) {
                usePersonalDataSwitch.setAttribute('checked', '');
                usePersonalDataSwitch.checked = true;
              } else {
                usePersonalDataSwitch.removeAttribute('checked');
                usePersonalDataSwitch.checked = false;
              }
            }

            if (considerPreviousMessagesSwitch) {
              if (considerPreviousMessagesChecked) {
                considerPreviousMessagesSwitch.setAttribute('checked', '');
                considerPreviousMessagesSwitch.checked = true;
              } else {
                considerPreviousMessagesSwitch.removeAttribute('checked');
                considerPreviousMessagesSwitch.checked = false;
              }
            }

            if (contextBar) {
              contextBar.setAttribute('value', originalContextBarValue);
              contextBar.setAttribute('alias', originalContextBarAlias);
            }
          };

          const onModalHide = () => {
            modal.removeEventListener('mdsModalHide', onModalHide);
            doRollback();
          };

          if (modal) {
            modal.addEventListener('mdsModalHide', onModalHide);
          }

          // After 2000ms, close modal (rollback runs on mdsModalHide)
          setTimeout(() => {
            if (modal) {
              modal.removeAttribute('opened');
            }
          }, 500);
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLearningFromTheUserWithoutLockIn);
    } else {
      initLearningFromTheUserWithoutLockIn();
    }
  </script>
  <Usage>
    <UsageItem variant="do">
      Use feedback and behavior to improve suggestions, and make that learning visible and editable.
    </UsageItem>
    <UsageItem variant="dont">
      Personalize in ways that are invisible or that users cannot review, correct, or reset.
    </UsageItem>
    <UsageItem variant="do">
      Provide "Reset" or "Clear personalization" so users can start fresh without losing the
      product.
    </UsageItem>
    <UsageItem variant="dont">
      Create lock-in where wrong or outdated inferences are hard or impossible to fix.
    </UsageItem>
  </Usage>
</UseCase>
