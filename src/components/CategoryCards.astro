---
import Icon from './Icon.astro';
import CardTextAnimation from './CardTextAnimation.astro';
import blobConfigs from '../data/blob-configs.json';
import categoriesData from '../data/categories.json';

const baseUrl = import.meta.env.BASE_URL;

// Map categories data and add full link URLs
const categories = categoriesData.map((category) => ({
  ...category,
  link: `${baseUrl}${category.path}`,
}));
---

<section class="pb-2000 px-600 desktop:px-1200 bg-white relative z-10">
  <div class="max-w-screen-wide w-full mx-auto">
    <div class="grid grid-cols-1 tablet:grid-cols-3 desktop:gap-800 gap-600">
      {
        categories.map((category) => (
          <a
            href={category.link}
            class="inline-flex flex-col group no-underline focus-bounce rounded-3xl"
            data-category-id={category.id}
          >
            <div class="grid auto-rows-min rounded-3xl align-self-start text-tone-neutral-03 p-600 group-hover:-translate-y-200 shadow-sm-sharp transition bg-tone-neutral/80 backdrop-blur group-[&:is(:hover,:focus-visible)]:bg-tone-neutral ease-out-expo duration-1000">
              <div
                class={`p-200 -translate-x-200 rounded-full inline-flex justify-self-start bg-transparent transition group-[&:is(:hover,:focus-visible)]:-translate-y-200 group-[&:is(:hover,:focus-visible)]:pt-200 ease-out-expo duration-1000 color-tone-neutral-03 ${category.iconHover}`}
              >
                <Icon name={category.icon} />
              </div>
              <h2 class="mb-300 text-title-h2 tablet-max:text-title-h3">{category.title}</h2>
              <p class="text-info-detail">{category.description}</p>
              <div class="mt-600 opacity-0 group-[&:is(:hover,:focus-visible)]:opacity-100 group-[&:is(:hover,:focus-visible)]:translate-y-0 transition translate-y-200 h-600">
                <mds-text text="â†’" animation="yugop" data-category-text={category.id} />
              </div>
            </div>
          </a>
        ))
      }
    </div>
  </div>
</section>

<CardTextAnimation />

<script
  define:vars={{ blobConfigs: JSON.stringify(blobConfigs), categories: JSON.stringify(categories) }}
>
  // Handle blob configuration changes and logo color on category card hover
  function initBlobConfigHover() {
    const categoryLinks = document.querySelectorAll('[data-category-id]');
    const configs = JSON.parse(blobConfigs);
    const categoriesData = JSON.parse(categories);
    const vvLogo = document.querySelector('.vv-logo');

    categoryLinks.forEach((link) => {
      const categoryId = link.getAttribute('data-category-id');
      const config = configs[categoryId];
      const category = categoriesData.find((c) => c.id === categoryId);

      if (!config) return;

      link.addEventListener('mouseenter', () => {
        // Update blob configuration
        if (typeof window !== 'undefined' && window.updateBlobConfig) {
          window.updateBlobConfig(config, true);
        }

        // Update logo classes
        if (vvLogo && category && category.logo) {
          // Remove all logo classes from other categories
          categoriesData.forEach((cat) => {
            if (cat.logo) {
              // Split logo string into individual classes and remove each one
              const classes = cat.logo.split(/\s+/).filter(Boolean);
              classes.forEach((cls) => {
                vvLogo.classList.remove(cls);
              });
            }
          });
          // Add current category logo classes (split by space)
          const classes = category.logo.split(/\s+/).filter(Boolean);
          classes.forEach((cls) => {
            vvLogo.classList.add(cls);
          });
        }
      });

      link.addEventListener('mouseleave', () => {
        // Reset to initial blob configuration
        if (typeof window !== 'undefined' && window.resetBlobConfig) {
          window.resetBlobConfig(true);
        }

        // Remove logo classes
        if (vvLogo && category && category.logo) {
          // Split logo string into individual classes and remove each one
          const classes = category.logo.split(/\s+/).filter(Boolean);
          classes.forEach((cls) => {
            vvLogo.classList.remove(cls);
          });
        }
      });
    });
  }

  // Wait for blob to be initialized before setting up hover handlers
  function waitForBlob(maxAttempts = 50, interval = 100) {
    let attempts = 0;

    const checkBlob = () => {
      if (typeof window !== 'undefined' && window.updateBlobConfig && window.resetBlobConfig) {
        initBlobConfigHover();
        return;
      }

      attempts++;
      if (attempts < maxAttempts) {
        setTimeout(checkBlob, interval);
      }
    };

    // Start checking
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(checkBlob, 100);
      });
    } else {
      setTimeout(checkBlob, 100);
    }
  }

  // Initialize
  waitForBlob();
</script>
