---
import CategoryCardItem from './CategoryCardItem.astro';
import CardTextAnimation from './CardTextAnimation.astro';
import blobConfigs from '../data/blob-configs.json';
import categoriesData from '../data/categories.json';

// Get base URL from Astro config and normalize it
// Remove trailing slash if present (except for root)
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl === '/' ? '' : rawBaseUrl.replace(/\/$/, '');

// Filter out draft categories in production (show them in development)
const visibleCategories = categoriesData.filter(
  (category) => !(category as any).draft || !import.meta.env.PROD
);

// Map categories data and add full link URLs
const categories = visibleCategories.map((category) => ({
  ...category,
  link: `${baseUrl}${category.path}`,
}));

// Determine grid columns based on number of visible categories
const gridColsClass =
  categories.length === 1
    ? 'grid-cols-1'
    : categories.length === 2
      ? 'grid-cols-1 tablet:grid-cols-2'
      : 'grid-cols-1 tablet:grid-cols-3';
---

<section class="pb-2000 px-600 desktop:px-1200 bg-white relative z-10">
  <div class="max-w-screen-wide w-full mx-auto">
    <div class={`grid ${gridColsClass} desktop:gap-800 gap-600`}>
      {
        categories.map((category) => (
          <CategoryCardItem
            id={category.id}
            link={category.link}
            icon={category.icon}
            title={category.title}
            description={category.description}
          />
        ))
      }
    </div>
  </div>
</section>

<CardTextAnimation />

<script
  define:vars={{ blobConfigs: JSON.stringify(blobConfigs), categories: JSON.stringify(categories) }}
>
  // Handle blob configuration changes and logo color on category card hover
  function initBlobConfigHover() {
    const categoryLinks = document.querySelectorAll('[data-category-id]');
    const configs = JSON.parse(blobConfigs);
    const categoriesData = JSON.parse(categories);
    const vvLogo = document.querySelector('.vv-logo');

    categoryLinks.forEach((link) => {
      const categoryId = link.getAttribute('data-category-id');
      const config = configs[categoryId];
      const category = categoriesData.find((c) => c.id === categoryId);

      if (!config) return;

      link.addEventListener('mouseenter', () => {
        // Update blob configuration
        if (typeof window !== 'undefined' && window.updateBlobConfig) {
          window.updateBlobConfig(config, true);
        }

        // Update logo classes
        if (vvLogo && category && category.logo) {
          // Remove all logo classes from other categories
          categoriesData.forEach((cat) => {
            if (cat.logo) {
              // Split logo string into individual classes and remove each one
              const classes = cat.logo.split(/\s+/).filter(Boolean);
              classes.forEach((cls) => {
                vvLogo.classList.remove(cls);
              });
            }
          });
          // Add current category logo classes (split by space)
          const classes = category.logo.split(/\s+/).filter(Boolean);
          classes.forEach((cls) => {
            vvLogo.classList.add(cls);
          });
        }
      });

      link.addEventListener('mouseleave', () => {
        // Reset to initial blob configuration
        if (typeof window !== 'undefined' && window.resetBlobConfig) {
          window.resetBlobConfig(true);
        }

        // Remove logo classes
        if (vvLogo && category && category.logo) {
          // Split logo string into individual classes and remove each one
          const classes = category.logo.split(/\s+/).filter(Boolean);
          classes.forEach((cls) => {
            vvLogo.classList.remove(cls);
          });
        }
      });
    });
  }

  // Wait for blob to be initialized before setting up hover handlers
  function waitForBlob(maxAttempts = 50, interval = 100) {
    let attempts = 0;

    const checkBlob = () => {
      if (typeof window !== 'undefined' && window.updateBlobConfig && window.resetBlobConfig) {
        initBlobConfigHover();
        return;
      }

      attempts++;
      if (attempts < maxAttempts) {
        setTimeout(checkBlob, interval);
      }
    };

    // Start checking
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(checkBlob, 100);
      });
    } else {
      setTimeout(checkBlob, 100);
    }
  }

  // Initialize
  waitForBlob();
</script>
