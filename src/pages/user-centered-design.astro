---
import CategoryLayout from '../layouts/CategoryLayout.astro';
import PrincipleCard from '../components/PrincipleCard.astro';
import Principles from '../components/Principles.astro';
import Nav from '../components/Nav.astro';
import SectionNav from '../components/SectionNav.astro';
import data from '../data/user-centered-design.json';
import Bibliography from '../components/Bibliography.astro';
import BibliographyItem from '../components/BibliographyItem.astro';
import BibliographySection from '../components/BibliographySection.astro';

const baseUrl = import.meta.env.BASE_URL;
const sectionPath = '/user-centered-design';

// Sort principles by title
const sortedPrinciples = [...data.principles].sort((a, b) => a.title.localeCompare(b.title));

// Filter bibliography items by type
const allBooks: any[] = [];
const allUrls: any[] = [];
if (data.bibliography && Array.isArray(data.bibliography)) {
  (data.bibliography as any[]).forEach((item: any) => {
    if (item.type === 'book') {
      allBooks.push(item);
    } else if (item.type === 'url') {
      allUrls.push(item);
    }
  });
}

// Remove duplicates based on URL and separate by type
const uniqueBooks = Array.from(new Map(allBooks.map((item: any) => [item.url, item])).values());
const uniqueUrls = Array.from(new Map(allUrls.map((item: any) => [item.url, item])).values());

// Sort alphabetically by author, then by title
const sortBibliography = (items: any[]) => {
  return items.sort((a: any, b: any) => {
    const authorCompare = (a.author || '').localeCompare(b.author || '');
    if (authorCompare !== 0) return authorCompare;
    return (a.title || '').localeCompare(b.title || '');
  });
};

const sortedBooks = sortBibliography(uniqueBooks);
const sortedUrls = sortBibliography(uniqueUrls);
---

<CategoryLayout
  title="User-Centered Design - Vittorio's Portfolio"
  sectionTitle={data.title}
  sectionDescription={data.description}
  categories={data.categories}
>
  <Principles>
    {
      sortedPrinciples
        // .filter((principle) => !(principle as any).draft)
        .map((principle) => (
          <PrincipleCard
            id={principle.id}
            title={principle.title}
            description={principle.description}
            category={principle.category}
            icon={principle.icon}
            color={
              data.categoryColors[principle.category as keyof typeof data.categoryColors] || ''
            }
            href={`${baseUrl}/user-centered-design/${principle.id}`}
          />
        ))
    }
  </Principles>
  {
    (sortedBooks.length > 0 || sortedUrls.length > 0) && (
      <div class="max-w-screen-desktop mx-auto mt-1200">
        <Bibliography>
          {sortedBooks.length > 0 && (
            <BibliographySection type="book">
              {sortedBooks.map((item: any) => (
                <BibliographyItem
                  author={item.author}
                  title={item.title}
                  description={item.description}
                  url={item.url}
                  status={item.status}
                />
              ))}
            </BibliographySection>
          )}
          {sortedUrls.length > 0 && (
            <BibliographySection type="url">
              {sortedUrls.map((item: any) => (
                <BibliographyItem
                  author={item.author}
                  title={item.title}
                  description={item.description}
                  url={item.url}
                  status={item.status}
                />
              ))}
            </BibliographySection>
          )}
        </Bibliography>
      </div>
    )
  }
  <div class="h-50 bg-tone-neutral-03 max-w-screen-desktop mx-auto mt-1200"></div>
  <Nav>
    <SectionNav baseUrl={baseUrl} sectionPath={sectionPath} principles={false} />
  </Nav>
</CategoryLayout>
