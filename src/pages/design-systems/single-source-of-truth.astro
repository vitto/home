---
import PrincipleLayout from '../../layouts/PrincipleLayout.astro';
import data from '../../data/design-systems.json';
import bibliographies from '../../data/bibliographies.json';
import Nav from '../../components/Nav.astro';
import SectionNav from '../../components/SectionNav.astro';
import PrincipleNav from '../../components/PrincipleNav.astro';
import Markdown from '../../components/Markdown.astro';
import Bibliography from '../../components/Bibliography.astro';
import BibliographyItem from '../../components/BibliographyItem.astro';
import BibliographySection from '../../components/BibliographySection.astro';
import Article from '../../components/Article.astro';
import StorybookAsThePrimaryReference from '../../components/use-cases/design-systems/single-source-of-truth/StorybookAsThePrimaryReference.astro';
import ComponentsDesignedAsPublicApis from '../../components/use-cases/design-systems/single-source-of-truth/ComponentsDesignedAsPublicApis.astro';
import CicdPipelinesAsAlignmentMechanisms from '../../components/use-cases/design-systems/single-source-of-truth/CicdPipelinesAsAlignmentMechanisms.astro';
import ExplicitProcessesForSystemChanges from '../../components/use-cases/design-systems/single-source-of-truth/ExplicitProcessesForSystemChanges.astro';
import AccessibilityEmbeddedInTheSourceOfTruth from '../../components/use-cases/design-systems/single-source-of-truth/AccessibilityEmbeddedInTheSourceOfTruth.astro';
const principle = data.principles.find((p) => p.id === 'single-source-of-truth')!;
// Get base URL from Astro config and normalize it
// Remove trailing slash if present (except for root)
const rawBaseUrl = import.meta.env.BASE_URL;
const baseUrl = rawBaseUrl === '/' ? '' : rawBaseUrl.replace(/\/$/, '');
const sectionPath = '/design-systems';
// Get bibliography items from bibliographies.json using principle.sources
const bibliography: any[] = [];
if (principle.sources && Array.isArray(principle.sources) && bibliographies) {
  principle.sources.forEach((sourceId: string) => {
    if ((bibliographies as any)[sourceId]) {
      bibliography.push((bibliographies as any)[sourceId]);
    }
  });
}
const books = bibliography?.filter((item: any) => item.type === 'book') || [];
const urls = bibliography?.filter((item: any) => item.type === 'url') || [];
const videos = bibliography?.filter((item: any) => item.type === 'video') || [];

// Sort bibliography alphabetically by author, then by title
const sortBibliography = (items: any[]) => {
  return items.sort((a: any, b: any) => {
    const authorCompare = (a.author || '').localeCompare(b.author || '');
    if (authorCompare !== 0) return authorCompare;
    return (a.title || '').localeCompare(b.title || '');
  });
};

const sortedBooks = books.length > 0 ? sortBibliography([...books]) : [];
const sortedUrls = urls.length > 0 ? sortBibliography([...urls]) : [];
const sortedVideos = videos.length > 0 ? sortBibliography([...videos]) : [];
---

<PrincipleLayout
  title={`${principle.title} - Design Systems`}
  principle={principle}
  categoryColors={data.categoryColors}
  sectionName={data.title}
  sectionPath="/design-systems"
>
  <Article>
    <Markdown
      content={`
When I design a design system, I treat it as the **single authoritative source** for components, patterns, accessibility rules, and behavioral decisions.

This approach reduces ambiguity, subjective interpretation, and divergence between design and development.

In practice, I have consistently observed that when multiple "sources of truth" coexist—design files, local implementations, undocumented patterns—teams start to:

- duplicate solutions,
- rebuild components locally,
- and make visual or technical decisions outside the system.

For this reason, anything that is not expressed within the design system should not be considered official.
Every extension or change must pass through the system itself, in an explicit, documented, and versioned way.

The goal is not control, but **clarity**: enabling teams to trust the system and focus on product work rather than interpretation and reconciliation.
    `}
    />

    <StorybookAsThePrimaryReference />
    <ComponentsDesignedAsPublicApis />
    <CicdPipelinesAsAlignmentMechanisms />
    <ExplicitProcessesForSystemChanges />
    <AccessibilityEmbeddedInTheSourceOfTruth />

    <Markdown
      content={`
  #### Why this principle matters

  A single source of truth is not about enforcing rigidity.

  It is about:

  - reducing decision noise,
  - increasing confidence in the system,
  - preventing the silent fragmentation that turns design systems into optional libraries.

  Without this principle, a design system inevitably becomes:

  - a theoretical reference,
  - a partially adopted toolkit,
  - or a document that teams gradually ignore.
  `}
    />
  </Article>

  {
    bibliography && (
      <Bibliography>
        {sortedBooks.length > 0 && (
          <BibliographySection type="book">
            {sortedBooks.map((item: any) => (
              <BibliographyItem
                author={item.author}
                title={item.title}
                description={item.description}
                url={item.url}
                status={item.status}
              />
            ))}
          </BibliographySection>
        )}
        {sortedUrls.length > 0 && (
          <BibliographySection type="url">
            {sortedUrls.map((item: any) => (
              <BibliographyItem
                author={item.author}
                title={item.title}
                description={item.description}
                url={item.url}
                status={item.status}
              />
            ))}
          </BibliographySection>
        )}
        {sortedVideos.length > 0 && (
          <BibliographySection type="video">
            {sortedVideos.map((item: any) => (
              <BibliographyItem
                author={item.author}
                title={item.title}
                description={item.description}
                url={item.url}
                status={item.status}
              />
            ))}
          </BibliographySection>
        )}
      </Bibliography>
    )
  }

  <Nav>
    <SectionNav baseUrl={baseUrl} sectionPath={sectionPath} />
    <PrincipleNav
      baseUrl={baseUrl}
      currentPrincipleId={principle.id}
      sectionPath={sectionPath}
      allPrinciples={data.principles}
    />
  </Nav>
</PrincipleLayout>
