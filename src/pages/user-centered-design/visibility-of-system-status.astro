---
import PrincipleLayout from '../../layouts/PrincipleLayout.astro';
import data from '../../data/user-centered-design.json';
import UseCase from '../../components/UseCase.astro';
import UseCaseInteractive from '../../components/UseCaseInteractive.astro';
const baseUrl = import.meta.env.BASE_URL;
const principle = data.principles.find((p) => p.id === 'visibility-of-system-status')!;

// Users list with name, avatar and status
const users = [
  {
    name: 'Mario Rossi',
    avatar: `${baseUrl}/assets/example-avatar-01.png`,
    status: 'offline' as const,
  },
  {
    name: 'Luigi Verdi',
    avatar: `${baseUrl}/assets/example-avatar-02.png`,
    status: 'online' as const,
  },
  {
    name: 'Giulia Arancioni',
    avatar: `${baseUrl}/assets/example-avatar-03.png`,
    status: 'busy' as const,
  },
  {
    name: 'Anna Neri',
    avatar: `${baseUrl}/assets/example-avatar-04.png`,
    status: 'offline' as const,
  },
  {
    name: 'Jamie Oliver',
    avatar: `${baseUrl}/assets/example-avatar-06.png`,
    status: 'online' as const,
  },
];

// Helper function to get status indicator class
function getStatusClass(status: 'online' | 'offline' | 'busy' | 'error') {
  switch (status) {
    case 'online':
      return 'bg-status-success-06';
    case 'offline':
      return 'bg-status-error-06';
    case 'busy':
      return 'bg-label-orange-07';
    case 'error':
      return 'bg-tone-neutral-07';
    default:
      return 'bg-status-success-06';
  }
}
---

<PrincipleLayout
  title={`${principle.title} - Design Systems`}
  principle={principle}
  categoryColors={data.categoryColors}
  sectionName={data.title}
  sectionPath="/design-systems"
>
  <UseCase
    title="Loading / Waiting"
    description="The system makes it clear that an operation is in progress and, when possible, communicates its duration or progress, reducing anxiety and uncertainty during the wait."
  >
    <UseCaseInteractive contentClass="min-h-[80px]">
      <mds-benchmark-bar
        class="min-h-[28px] max-w-8000 w-full"
        value="0"
        max="100"
        variant="primary"
        alias="Ready"
        data-progress-bar
      >
        <span data-progress-text>Ready to save data</span>
      </mds-benchmark-bar>
      <mds-button class="max-w-8000 w-full" data-save-button>Proceed</mds-button>
      <script>
        function initSaveDataDemo() {
          // Get the UseCase scope (article and container) for this script
          // Can pass id explicitly or let it find automatically
          const scope = (window as any).getUseCaseScope?.('loading-waiting');
          if (!scope) return;

          const { container } = scope;

          // Scope all queries to the container
          const saveButton = container.querySelector('[data-save-button]');
          const progressBar = container.querySelector('[data-progress-bar]');
          const progressText = container.querySelector('[data-progress-text]');

          if (!saveButton || !progressBar || !progressText) return;

          const progressStates = [
            { value: 0, alias: 'Ready', text: 'Ready to save data' },
            { value: 20, alias: 'Files', text: 'Saving' },
            { value: 40, alias: 'Images', text: 'Saving' },
            { value: 60, alias: 'Metadata', text: 'Saving' },
            { value: 80, alias: 'Personal data', text: 'Saving' },
            { value: 100, alias: 'Complete', text: 'Saving' },
          ];

          let isSaving = false;
          let currentStateIndex = 0;

          const resetDemo = () => {
            isSaving = false;
            currentStateIndex = 0;
            saveButton.removeAttribute('await');
            saveButton.removeAttribute('icon');
            saveButton.setAttribute('variant', 'primary');
            saveButton.textContent = 'Proceed';
            progressBar.setAttribute('value', '0');
            progressBar.setAttribute('alias', 'Ready');
            progressText.textContent = 'Ready to save data';
          };

          const updateProgress = () => {
            const state = progressStates[currentStateIndex];
            progressBar.setAttribute('value', String(state.value));
            progressBar.setAttribute('alias', state.alias);
            progressText.textContent = state.text;

            // Update button when reaching 100%
            if (state.value === 100) {
              saveButton.textContent = 'Complete';
              saveButton.setAttribute('icon', 'mi/baseline/done');
              saveButton.removeAttribute('await');
              saveButton.setAttribute('variant', 'success');
            }

            currentStateIndex++;

            if (currentStateIndex < progressStates.length) {
              // Random delay between 600-1000ms for each step
              const randomDelay = Math.floor(Math.random() * (1000 - 600 + 1)) + 600;
              setTimeout(updateProgress, randomDelay);
            } else {
              // Wait 1 second at 100% before resetting
              setTimeout(() => {
                resetDemo();
              }, 2000);
            }
          };

          saveButton.addEventListener('click', () => {
            if (isSaving) return;

            isSaving = true;
            saveButton.setAttribute('await', 'true');
            saveButton.textContent = 'Please wait...';
            currentStateIndex = 1; // Start from first progress state
            updateProgress();
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initSaveDataDemo);
        } else {
          initSaveDataDemo();
        }
      </script>
    </UseCaseInteractive>
  </UseCase>

  <UseCase
    title="User Actions"
    description="Every input produces immediate and perceptible feedback, so the user knows the action has been received and is being processed or completed."
  >
    <UseCaseInteractive contentClass="min-h-[36px]">
      <mds-button class="max-w-8000 w-full" data-save-button>Save</mds-button>
      <script>
        function initSaveButton() {
          // Get the UseCase scope (article and container) for this script
          const scope = (window as any).getUseCaseScope?.('user-actions');
          if (!scope) return;

          const { container } = scope;

          // Scope query to the container
          const saveButton = container.querySelector('[data-save-button]');
          if (!saveButton) return;

          saveButton.addEventListener('click', () => {
            saveButton.textContent = 'Element saved successfully';
            saveButton.setAttribute('disabled', 'true');
            saveButton.setAttribute('icon', 'mi/baseline/done');
            saveButton.setAttribute('variant', 'success');
            setTimeout(() => {
              saveButton.textContent = 'Save';
              saveButton.removeAttribute('disabled');
              saveButton.removeAttribute('icon');
              saveButton.setAttribute('variant', 'primary');
            }, 2000);
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initSaveButton);
        } else {
          initSaveButton();
        }
      </script>
    </UseCaseInteractive>
  </UseCase>

  <UseCase
    title="Background Processes"
    description="Activities that are not immediately active remain visible in the system state, preventing the user from losing context or repeating actions already initiated."
  >
    <UseCaseInteractive contentClass="min-h-[392px]">
      <mds-entity await class="w-full max-w-8000">
        <mds-text typography="h6">Processing metadata</mds-text>
        <mds-badge variant="primary" slot="detail">book</mds-badge>
        <mds-text typography="caption" slot="detail">2 hours estimated to finish</mds-text>
      </mds-entity>
      <mds-text typography="caption"
        >You can edit the main metadata of the book while it's being processed.</mds-text
      >
      <mds-input-field label="Title" class="w-full max-w-8000">
        <mds-input placeholder="Es: Open" value="Open"></mds-input>
      </mds-input-field>
      <mds-input-field label="Description" class="w-full max-w-8000">
        <mds-input
          type="textarea"
          maxlength="240"
          placeholder="Es: Andre Agassi's autobiography: a raw and honest account of talent, pressure, hatred for tennis, and personal redemption. It's not a book about sports, but about being human under enormous expectations."
          value="Andre Agassi's autobiography: a raw and honest account of talent, pressure, hatred for tennis, and personal redemption. It's not a book about sports, but about being human under enormous expectations."
        ></mds-input>
      </mds-input-field>
    </UseCaseInteractive>
  </UseCase>

  <UseCase
    title="Errors and Problems"
    description="The system promptly reports anomalies and crashes, explaining what is happening and whether any action is required."
  >
    <UseCaseInteractive contentClass="min-h-[360px]">
      <mds-button class="transition min-h-[32px]" variant="dark" tone="weak" data-simulate-button>
        Simulate connection problem
      </mds-button>
      <div
        class="inline-flex flex-col items-center gap-400 p-600 rounded-xl bg-tone-neutral-09 relative w-full max-w-8000"
      >
        <mds-push-notification-item
          deletable="false"
          icon="mi/baseline/wifi-tethering-error"
          message="Please check your internet connection and try again."
          subject="Connection lost"
          variant="error"
          class="transition absolute top-100 right-100 left-100 opacity-0 -translate-y-600 pointer-events-none z-10"
          data-error-notification
        >
          <mds-button size="sm" slot="action" tone="weak" variant="error" data-retry-button
            >Retry</mds-button
          >
        </mds-push-notification-item>
        {
          users.map((user) => (
            <mds-author class="gap-200 min-h-600">
              <div slot="avatar" class="inline-flex items-center justify-center relative">
                <mds-avatar src={user.avatar} class="size-600" />
                <div
                  class={`size-300 rounded-full ${getStatusClass(user.status)} absolute bottom-0 -right-100 border-solid border-2 border-tone-neutral-09`}
                  data-status-indicator
                />
              </div>
              <mds-text typography="detail">{user.name}</mds-text>
            </mds-author>
          ))
        }
        <mds-entity
          src={`${baseUrl}/assets/example-avatar-05.png`}
          class="w-full max-w-8000 min-h-[60px]"
        >
          <mds-text typography="h6">Mario Rossi</mds-text>
          <div
            slot="detail"
            class="size-300 rounded-full bg-status-success-06"
            data-status-indicator
          >
          </div>
          <mds-text typography="caption" slot="detail" data-status-text>Offline</mds-text>
          <div slot="action" class="inline-flex items-center justify-center fill-tone-neutral-04">
            <mds-icon name="mi/outline/more-vert"></mds-icon>
          </div>
        </mds-entity>
      </div>
      <script>
        function initConnectionDemo() {
          // Get the UseCase scope (article and container) for this script
          const scope = (window as any).getUseCaseScope?.('errors-and-problems');
          if (!scope) return;

          const { container } = scope;

          const simulateButton = container.querySelector('[data-simulate-button]');
          const notification = container.querySelector('[data-error-notification]');
          const retryButton = container.querySelector('[data-retry-button]');
          const statusIndicator = container.querySelector('[data-status-indicator]');
          const statusText = container.querySelector('[data-status-text]');

          // Find all user status indicators (both in mds-author and mds-entity)
          const allStatusIndicators = Array.from(
            container.querySelectorAll('[data-status-indicator]')
          ) as HTMLElement[];

          if (!simulateButton || !notification || !retryButton || !statusIndicator || !statusText)
            return;

          // Store original status classes for all indicators
          const originalStatusClasses = allStatusIndicators.map((indicator) => {
            // Get the current status class (online, offline, busy)
            const classes = indicator.className.split(' ');
            const statusClass =
              classes.find((cls) => cls.startsWith('bg-status-') || cls.startsWith('bg-label-')) ||
              'bg-status-success-06';
            return statusClass;
          });

          const restoreInitialState = () => {
            // Show simulate button
            simulateButton.classList.remove('translate-x-600');
            simulateButton.classList.remove('opacity-0');
            simulateButton.classList.remove('pointer-events-none');
            simulateButton.classList.add('opacity-100');
            // Hide notification (connection is functional)
            notification.classList.remove('opacity-100');
            notification.classList.remove('translate-y-0');
            notification.classList.remove('delay-500');
            notification.classList.add('opacity-0');
            notification.classList.add('pointer-events-none');
            notification.classList.add('-translate-y-600');
            // Restore all status indicators to their original state
            allStatusIndicators.forEach((indicator, index) => {
              // Remove error class
              indicator.classList.remove('bg-tone-neutral-07');
              // Restore original status class
              indicator.classList.remove(
                'bg-status-success-06',
                'bg-status-error-06',
                'bg-label-orange-07'
              );
              indicator.classList.add(originalStatusClasses[index]);
            });
            // Change status text to Online
            statusText.textContent = 'Online';
          };

          const simulateConnectionProblem = () => {
            // Hide simulate button
            simulateButton.classList.add('translate-x-600');
            simulateButton.classList.add('opacity-0');
            simulateButton.classList.add('pointer-events-none');
            simulateButton.classList.remove('opacity-100');
            // Show notification (connection problem)
            notification.classList.remove('opacity-0');
            notification.classList.remove('-translate-y-600');
            notification.classList.add('delay-500');
            notification.classList.remove('pointer-events-none');
            notification.classList.add('opacity-100');
            // Set all status indicators to error state
            allStatusIndicators.forEach((indicator) => {
              // Remove all status classes
              indicator.classList.remove(
                'bg-status-success-06',
                'bg-status-error-06',
                'bg-label-orange-07'
              );
              // Add error class
              indicator.classList.add('bg-tone-neutral-07');
            });
            // Change status text to Offline
            statusText.textContent = 'Offline';
          };

          // Set initial state
          restoreInitialState();

          // Add event listeners
          simulateButton.addEventListener('click', simulateConnectionProblem);
          retryButton.addEventListener('click', restoreInitialState);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initConnectionDemo);
        } else {
          initConnectionDemo();
        }
      </script>
    </UseCaseInteractive>
  </UseCase>

  <UseCase
    title="Navigation and Flows"
    description="The interface clearly communicates the current position and progress within a path, preventing disorientation and abandonment."
  >
    <UseCaseInteractive>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quos.</p>
    </UseCaseInteractive>
  </UseCase>

  <UseCase
    title="Input and Validation"
    description="The status of the data entered is always clear, allowing the user to immediately know whether what they are doing is correct or requires correction."
  >
    <UseCaseInteractive>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quos.</p>
    </UseCaseInteractive>
  </UseCase>

  <UseCase
    title="System and Settings"
    description="Configurations instantly reflect their actual state, so the user never has to guess whether a change has been applied or not."
  >
    <UseCaseInteractive>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quos.</p>
    </UseCaseInteractive>
  </UseCase>
</PrincipleLayout>
