---
import SectionLayout from './SectionLayout.astro';
import Section from '../components/Section.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PrincipleHeader from '../components/PrincipleHeader.astro';
import Button from '../components/Button.astro';
import Icon from '../components/Icon.astro';
interface Props {
  title: string;
  principle: {
    icon: string;
    category: string;
    title: string;
    description: string;
  };
  categoryColors: Record<string, string>;
  sectionName: string;
  sectionPath: string;
}

const baseUrl = import.meta.env.BASE_URL;
const { title, principle, categoryColors, sectionName, sectionPath } = Astro.props;
---

<script is:inline>
  // Global utility function to find the UseCase article and container for the current script
  // This function can be called with an id, or it will try to find the article containing the calling script
  window.getUseCaseScope = function getUseCaseScope(id) {
    let article = null;

    if (id) {
      // If id is provided, use it directly
      article = document.getElementById(id);
    } else {
      // Otherwise, try to find the article containing the current script
      const currentScript = document.currentScript;
      if (currentScript) {
        article = currentScript.closest('article');
      }
    }

    if (!article) return null;

    const articleId = article.getAttribute('id');
    if (!articleId) return null;

    const container = article.querySelector('.use-case-interactive');
    if (!container) return null;

    return {
      article: article,
      articleId: articleId,
      container: container,
    };
  };

  // Function to remove CLS prevent style for a specific use case container
  window.removeCLSPreventStyle = function removeCLSPreventStyle(container) {
    if (!container) return;

    // Find element with data-cls-prevent attribute within this container
    const element = container.querySelector('[data-cls-prevent]');
    if (!element) return;

    // Find all potential web components (tags with hyphens) inside this element
    const allElements = element.querySelectorAll('*');
    const webComponentTags = new Set();

    allElements.forEach((el) => {
      const tagName = el.tagName.toLowerCase();
      // Web components have hyphens in their tag name
      if (tagName.includes('-')) {
        webComponentTags.add(tagName);
      }
    });

    if (webComponentTags.size === 0) {
      // No web components found, remove the style attribute immediately
      requestAnimationFrame(() => {
        element.removeAttribute('style');
        element.removeAttribute('data-cls-prevent');
      });
    } else {
      // Wait for all web components to be defined
      const promises = Array.from(webComponentTags).map((tagName) => {
        return customElements.whenDefined(tagName).catch(() => {
          // If the element is not a custom element, resolve immediately
          return Promise.resolve();
        });
      });

      Promise.all(promises).then(() => {
        // Small delay to ensure rendering is complete
        requestAnimationFrame(() => {
          element.removeAttribute('style');
          element.removeAttribute('data-cls-prevent');
        });
      });
    }
  };

  // Function to initialize viewport opacity observer for a specific use case container
  window.initViewportOpacity = function initViewportOpacity(container) {
    if (!container) return;

    // Find element with data-cls-prevent attribute within this container
    const element = container.querySelector('[data-cls-prevent]');
    if (!element) return;

    // Create Intersection Observer to detect when element enters viewport
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Element is in viewport, change opacity from 0 to 100
            const targetElement = entry.target;
            targetElement.classList.remove('opacity-0');
            targetElement.classList.add('opacity-100');
            // Unobserve after first intersection to avoid repeated triggers
            observer.unobserve(targetElement);
          }
        });
      },
      {
        // Trigger when element is 10% visible
        threshold: 0.1,
        // Start observing slightly before element enters viewport
        rootMargin: '0px 0px -10% 0px',
      }
    );

    // Observe the element
    observer.observe(element);
  };
</script>
<SectionLayout title={title}>
  <Section contentClass="gap-1200 mobile:gap-600">
    <Header />
    <PrincipleHeader
      principle={principle}
      categoryColors={categoryColors}
      sectionName={sectionName}
      sectionPath={sectionPath}
    />
    <slot />
    <div class="h-50 bg-tone-neutral-03"></div>
    <Button href={baseUrl} variant="outline" class="justify-self-center">
      <Icon name="mi/baseline/arrow-back" />
      Back to Home
    </Button>
  </Section>
</SectionLayout>
<Footer />
